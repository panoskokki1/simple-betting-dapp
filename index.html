<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SimpleBetting DApp (Besu)</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 820px; margin: 24px auto; padding: 0 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    input, select { padding: 9px; border-radius: 10px; border: 1px solid #ccc; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .muted { color: #666; font-size: 14px; }
    pre { background: #f6f6f6; border-radius: 10px; padding: 12px; overflow: auto; }
  </style>
</head>
<body>
  <h2>SimpleBetting DApp (Besu EduNet)</h2>
  <div class="muted">
    Συνδέεται μέσω MetaMask στο Besu (QBFT). Αν δεν είσαι στο σωστό network, το MetaMask θα στο πει.
  </div>

  <div class="card">
    <div class="row">
      <button id="btnConnect">Connect Wallet</button>
      <div>
        <div><b>Account:</b> <span id="account">-</span></div>
        <div><b>Network:</b> <span id="network">-</span></div>
      </div>
    </div>
    <div class="muted" style="margin-top:8px;">
      Contract: <span id="contractAddr"></span>
    </div>
  </div>

  <div class="card">
    <h3>Κατάσταση Contract (read)</h3>
    <div class="row">
      <button id="btnRefresh">Refresh</button>
    </div>
    <pre id="state">-</pre>
  </div>

  <div class="card">
    <h3>Place Bet</h3>
    <div class="row">
      <label>Outcome:
        <select id="betOutcome">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </label>

      <label>Value:
        <input id="betValue" type="number" step="1" value="1000" style="width:120px;" />
      </label>

      <label>Unit:
        <select id="betUnit">
          <option value="gwei" selected>gwei</option>
          <option value="wei">wei</option>
          <option value="ether">ether</option>
        </select>
      </label>

      <button id="btnPlaceBet">PlaceBet</button>
    </div>
    <div class="muted">Tip: αν σου έβγαζε “Must send ETH”, εδώ στέλνεις ποσό > 0 (π.χ. 1000 gwei).</div>
  </div>

  <div class="card">
    <h3>Set Result (oracle)</h3>
    <div class="row">
      <label>Winning outcome:
        <select id="winOutcome">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </label>
      <button id="btnSetResult">SetResult</button>
    </div>
    <div class="muted">Μόνο το oracle account θα το περάσει. Αν δεν είσαι oracle, θα γίνει revert.</div>
  </div>

  <div class="card">
    <h3>Withdraw Winnings</h3>
    <div class="row">
      <button id="btnWithdraw">Withdraw</button>
    </div>
  </div>

  <div class="card">
    <h3>Logs</h3>
    <pre id="logs">-</pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.14.0/dist/ethers.umd.min.js"></script>
  <script>
    // ✅ ΒΑΛΕ ΕΔΩ ΤΟ CONTRACT ADDRESS ΣΟΥ:
    const CONTRACT_ADDRESS = "0x8Ef38c8f7dae8156145eB03282565D0cEc05AEdd";

    // ABI (αυτό που έστειλες)
    const ABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"bets","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"outcome","type":"uint256"},{"internalType":"bool","name":"claimed","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"oracle","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_outcome","type":"uint256"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[],"name":"resultSet","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_winningOutcome","type":"uint256"}],"name":"setResult","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"winningOutcome","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"withdrawWinnings","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let provider, signer, contract;

    const el = (id) => document.getElementById(id);
    const log = (msg) => {
      const prev = el("logs").textContent === "-" ? "" : el("logs").textContent + "\n";
      el("logs").textContent = prev + msg;
    };

    el("contractAddr").textContent = CONTRACT_ADDRESS;

    async function connect() {
      if (!window.ethereum) {
        alert("Δεν βρέθηκε MetaMask.");
        return;
      }
      await window.ethereum.request({ method: "eth_requestAccounts" });

      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      const addr = await signer.getAddress();

      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

      el("account").textContent = addr;

      const net = await provider.getNetwork();
      el("network").textContent = `${net.name} (chainId=${net.chainId})`;

      log(`Connected: ${addr}`);
      await refreshState();
    }

    async function refreshState() {
      if (!contract || !signer) {
        alert("Κάνε πρώτα Connect Wallet.");
        return;
      }
      const user = await signer.getAddress();

      const oracle = await contract.oracle();
      const resultSet = await contract.resultSet();
      const winningOutcome = await contract.winningOutcome();

      const bet = await contract.bets(user); // returns [amount, outcome, claimed]
      const amount = bet.amount?.toString?.() ?? bet[0].toString();
      const outcome = bet.outcome?.toString?.() ?? bet[1].toString();
      const claimed = bet.claimed ?? bet[2];

      el("state").textContent =
        `oracle: ${oracle}\n` +
        `resultSet: ${resultSet}\n` +
        `winningOutcome: ${winningOutcome.toString()}\n\n` +
        `your bet:\n` +
        `  amount(wei): ${amount}\n` +
        `  outcome: ${outcome}\n` +
        `  claimed: ${claimed}\n`;

      log("State refreshed.");
    }

    function parseValue(v, unit) {
      // ethers v6 parseUnits wants string
      if (unit === "ether") return ethers.parseEther(String(v));
      return ethers.parseUnits(String(v), unit); // wei/gwei
    }

    async function placeBet() {
      if (!contract) return alert("Κάνε πρώτα Connect Wallet.");

      const outcome = el("betOutcome").value;
      const v = el("betValue").value;
      const unit = el("betUnit").value;

      const value = parseValue(v, unit);

      log(`placeBet(${outcome}) with value=${v} ${unit} ...`);
      const tx = await contract.placeBet(outcome, { value });
      log(`tx sent: ${tx.hash}`);
      const receipt = await tx.wait();
      log(`confirmed in block: ${receipt.blockNumber}`);
      await refreshState();
    }

    async function setResult() {
      if (!contract) return alert("Κάνε πρώτα Connect Wallet.");

      const w = el("winOutcome").value;
      log(`setResult(${w}) ...`);
      const tx = await contract.setResult(w);
      log(`tx sent: ${tx.hash}`);
      const receipt = await tx.wait();
      log(`confirmed in block: ${receipt.blockNumber}`);
      await refreshState();
    }

    async function withdraw() {
      if (!contract) return alert("Κάνε πρώτα Connect Wallet.");

      log(`withdrawWinnings() ...`);
      const tx = await contract.withdrawWinnings();
      log(`tx sent: ${tx.hash}`);
      const receipt = await tx.wait();
      log(`confirmed in block: ${receipt.blockNumber}`);
      await refreshState();
    }

    el("btnConnect").onclick = connect;
    el("btnRefresh").onclick = refreshState;
    el("btnPlaceBet").onclick = () => placeBet().catch(e => log("ERROR: " + (e?.shortMessage || e?.message)));
    el("btnSetResult").onclick = () => setResult().catch(e => log("ERROR: " + (e?.shortMessage || e?.message)));
    el("btnWithdraw").onclick = () => withdraw().catch(e => log("ERROR: " + (e?.shortMessage || e?.message)));

    // auto log if account/network changes
    if (window.ethereum) {
      window.ethereum.on("accountsChanged", () => { log("accountsChanged"); });
      window.ethereum.on("chainChanged", () => { log("chainChanged (refresh page recommended)"); });
    }
  </script>
</body>
</html>
